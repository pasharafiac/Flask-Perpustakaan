{% extends "base.html" %}

{% block title %}Dashboard - Perpustakaan Digital{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-2 text-center">Selamat datang di Perpustakaan Digital, {{ username.fullname }}!</h1>
    <p class="text-center mb-5">Login sebagai: {{ username.role }}</p>

    <div id="bookCarousel" class="carousel slide mb-4" data-bs-ride="carousel">
        <div class="carousel-inner">
            {% set book_list = [] %}
            {% for category, books in books.items() %}
                {% for book in books %}
                    {% if book_list|length < 8 %}
                        {% set _ = book_list.append(book) %}
                    {% endif %}
                {% endfor %}
            {% endfor %}

            {% for i in range(0, book_list|length, 4) %}
                <div class="carousel-item {% if loop.first %}active{% endif %}">
                    <div class="row justify-content-center">
                        {% for book in book_list[i:i+4] %}
                            <div class="col-md-3 mb-4">
                                <div class="card h-100 mx-2">
                                    <div style="height: 300px; overflow: hidden;">
                                        <img src="{{ book.cover_image }}" class="card-img-top" alt="{{ book.title }}" style="width: 100%; height: 100%; object-fit: cover;">
                                    </div>
                                    <div class="card-body d-flex flex-column justify-content-between" style="height: 120px;">
                                        <h6 class="card-title text-center mb-2">{{ book.title }}</h6>
                                        <p class="card-text text-center mb-0"><small class="text-muted">{{ book.author }}</small></p>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#bookCarousel" data-bs-slide="prev" style="opacity: 0;">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#bookCarousel" data-bs-slide="next" style="opacity: 0;">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
        </button>
    </div>

    {% if username['role'] in ['admin', 'petugas'] %}
        <div class="mt-5">
            <h2 class="mb-4">Panel Kontrol Admin</h2>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <div class="card h-100">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">Kelola Buku</h5>
                                <p class="card-text flex-grow-1">Tambah, ubah, atau hapus buku dari perpustakaan.</p>
                                {% if username['role'] == 'admin' %}
                                    <a href="#" class="btn btn-primary mt-auto">Klik Disini</a>
                                {% elif username['role'] == 'petugas' %}
                                    <button class="btn btn-secondary mt-auto" disabled>Anda tidak memiliki akses</button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="card h-100">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">Kelola Petugas</h5>
                                <p class="card-text flex-grow-1">Tambah, ubah, atau hapus data petugas perpustakaan.</p>
                                {% if username['role'] == 'admin' %}
                                    <a href="#" class="btn btn-primary mt-auto">Klik Disini</a>
                                {% elif username['role'] == 'petugas' %}
                                    <button class="btn btn-secondary mt-auto" disabled>Anda tidak memiliki akses</button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="card h-100">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">Kelola Data Kelas</h5>
                                <p class="card-text flex-grow-1">Akses statistik dan laporan perpustakaan.</p>
                                {% if username['role'] == 'admin' %}
                                    <a href="#" class="btn btn-primary mt-auto">Klik Disini</a>
                                {% elif username['role'] == 'petugas' %}
                                    <button class="btn btn-secondary mt-auto" disabled>Anda tidak memiliki akses</button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <div class="card h-100">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">Kelola Data Peminjam</h5>
                                <p class="card-text flex-grow-1">Tambah, ubah, atau hapus data peminjam.</p>
                                {% if username['role'] == 'admin' %}
                                    <a href="#" class="btn btn-primary mt-auto">Klik Disini</a>
                                {% elif username['role'] == 'petugas' %}
                                    <button class="btn btn-secondary mt-auto" disabled>Anda tidak memiliki akses</button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="card h-100">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">Entri Transaksi Peminjaman</h5>
                                <p class="card-text flex-grow-1">Catat transaksi peminjaman buku baru.</p>
                                <a href="#" class="btn btn-primary mt-auto">Klik Disini</a>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="card h-100">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">History Peminjaman</h5>
                                <p class="card-text flex-grow-1">Lihat riwayat peminjaman buku.</p>
                                <a href="{{ url_for('history_transaction', user=username['username']) }}" class="btn btn-primary mt-auto">Klik Disini</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="card h-100">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">Generate Laporan Perpustakaan</h5>
                        <p class="card-text flex-grow-1">Buat laporan mengenai aktivitas perpustakaan, termasuk peminjaman, pengembalian, dan statistik lainnya.</p>
                        {% if username['role'] == 'admin' %}
                            <a href="#" class="btn btn-primary mt-auto">Generate Laporan</a>
                        {% elif username['role'] == 'petugas' %}
                            <button class="btn btn-secondary mt-auto" disabled>Anda tidak memiliki akses</button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <div class="mt-5">
            <h2 class="mb-4">Statistik Perpustakaan</h2>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body d-flex flex-column justify-content-center align-items-center">
                            <h5 class="card-title text-center">Total Buku</h5>
                            <p class="card-text display-4 mt-3">1,234</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body d-flex flex-column justify-content-center align-items-center">
                            <h5 class="card-title text-center">Buku Dipinjam</h5>
                            <p class="card-text display-4 mt-3">87</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body d-flex flex-column justify-content-center align-items-center">
                            <h5 class="card-title text-center">Pengguna Aktif</h5>
                            <p class="card-text display-4 mt-3">456</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-5">
            <h2 class="mb-4">Transaksi Buku Terkini</h2>
            <div class="card" style="min-height: 100px;">
                <div class="card-body d-flex align-items-center justify-content-center">
                    <p id="liveTransaction" class="mb-0 text-center">
                        <!-- Live transaction will be inserted here -->
                    </p>
                </div>
            </div>
        </div>
        <div class="mt-5">
            <h2 class="mb-4 text-center">Transaksi Peminjaman & Pinjam Buku</h2>
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-body text-center d-flex flex-column justify-content-between">
                            <div>
                                <h5 class="card-title">Riwayat Peminjaman</h5>
                                <p class="card-text">Lihat daftar buku yang sedang dipinjam dan riwayat peminjaman.</p>
                            </div>
                            <a href="{{ url_for('history_transaction', user=username['username']) }}" class="btn btn-primary mt-3">Lihat Transaksi Peminjaman</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-body text-center d-flex flex-column justify-content-between">
                            <div>
                                <h5 class="card-title">Pinjam Buku</h5>
                                <p class="card-text">Pinjam buku baru dari koleksi perpustakaan.</p>
                            </div>
                            <a href="{{ url_for('borrow_book') }}" class="btn btn-primary mt-3">Pinjam Buku Baru</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- logout button -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <a href="{{ url_for('logout') }}" class="btn btn-danger btn-lg rounded shadow">
            <i class="bi bi-box-arrow-right"></i> Logout
        </a>
    </div>

    <!-- Bootstrap Icons CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const bookTitles = [
            "Laskar Pelangi", "Bumi Manusia", "Pulang", "Negeri 5 Menara",
            "Sang Pemimpi", "Perahu Kertas", "Ayat-Ayat Cinta", "Ronggeng Dukuh Paruk",
            "Cantik Itu Luka", "Lelaki Harimau", "Amba", "Supernova"
        ];

        const names = [
            "Budi", "Siti", "Andi", "Dewi", "Rudi", "Lina", "Joko", "Rina",
            "Agus", "Nia", "Dedi", "Putri", "Hadi", "Sari", "Eko", "Dina"
        ];

        function getRandomItem(array) {
            return array[Math.floor(Math.random() * array.length)];
        }

        function createTransaction() {
            const action = Math.random() > 0.5 ? "meminjam" : "mengembalikan";
            const book = getRandomItem(bookTitles);
            const person = getRandomItem(names);
            return `${person} baru saja ${action} buku "${book}"`;
        }

        function updateTransaction() {
            const transactionElement = document.getElementById('liveTransaction');
            if (transactionElement) {
                transactionElement.textContent = createTransaction();
            } else {
                console.error("Element dengan id 'liveTransaction' tidak ditemukan");
            }
        }

        // Display initial transaction on page load
        updateTransaction();

        // Update every second
        setInterval(updateTransaction, 1000);
    });

    document.addEventListener('DOMContentLoaded', function() {
        var bookCarousel = new bootstrap.Carousel(document.getElementById('bookCarousel'), {
            interval: 5000,
            wrap: true
        });

        var carouselElement = document.getElementById('bookCarousel');
        var prevButton = carouselElement.querySelector('.carousel-control-prev');
        var nextButton = carouselElement.querySelector('.carousel-control-next');

        carouselElement.addEventListener('mouseenter', function() {
            prevButton.style.opacity = '1';
            nextButton.style.opacity = '1';
        });

        carouselElement.addEventListener('mouseleave', function() {
            prevButton.style.opacity = '0';
            nextButton.style.opacity = '0';
        });
    });
</script>
{% endblock %}
